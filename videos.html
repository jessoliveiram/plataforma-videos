<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Playlist de Vídeos DASH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.7/shaka-player.compiled.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; text-align: center; }
        #playlist { list-style: none; padding: 0; margin: 2em auto; max-width: 600px; }
        #playlist li { background: #fff; margin: 0.5em 0; padding: 1em; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        #playlist li.active { background: #cce5ff; font-weight: bold; }
        video { width: 80vw; max-width: 900px; margin: 2em auto; background: #000; }
    </style>
</head>
<body>
    <h1>Playlist de Streaming MPEG-DASH</h1>
    <label for="username">Seu nome:</label>
    <input type="text" id="username" placeholder="Digite seu nome" required style="margin-bottom:1em;">
    <ul id="playlist">
      <!-- A lista está em playlist.json -->
    </ul>
    <video id="videoPlayer" controls autoplay></video>
    <p>Selecione um vídeo acima para assistir. O próximo será carregado automaticamente ao terminar.</p>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!shaka.Player.isBrowserSupported()) {
                alert('Shaka Player não é suportado neste navegador.');
                return;
            }
            const video = document.getElementById('videoPlayer');
            const player = new shaka.Player(video);
            const playlistEl = document.getElementById('playlist');
            let playlist = [];
            let current = 0;

            function renderPlaylist() {
                playlistEl.innerHTML = '';
                playlist.forEach((item, idx) => {
                    const li = document.createElement('li');
                    li.textContent = item.title;
                    li.setAttribute('data-src', item.src);
                    if (idx === current) li.classList.add('active');
                    li.addEventListener('click', () => playVideo(idx));
                    playlistEl.appendChild(li);
                });
            }

            function playVideo(index) {
                const src = playlist[index].src;
                player.load(src).then(function() {
                    console.log('Vídeo carregado:', src);
                }).catch(function(error) {
                    console.error('Erro ao carregar o vídeo:', error);
                });
                current = index;
                renderPlaylist();
            }

            // Função para obter o nome do usuário
            function getUsername() {
                return document.getElementById('username').value || 'desconhecido';
            }

            video.addEventListener('ended', function() {
                if (current + 1 < playlist.length) {
                    playVideo(current + 1);
                }
            });

            // Carrega a playlist do arquivo JSON
            fetch('playlist.json')
                .then(res => res.json())
                .then(data => {
                    playlist = data;
                    renderPlaylist();
                    playVideo(0);
                })
                .catch(err => {
                    playlistEl.innerHTML = '<li>Erro ao carregar playlist.json</li>';
                });

            // Envio de métricas com nome do usuário
            function sendMetrics(stats) {
                stats.username = getUsername();
                const blob = new Blob([JSON.stringify(stats, null, 2)], { type: 'application/json' });
                navigator.sendBeacon && navigator.sendBeacon('/shaka_metrics.json', blob);
            }

            // Métricas de taxa de abandono
            let watchedTime = 0;
            let lastTime = 0;

            video.addEventListener('play', function() {
                lastTime = video.currentTime;
            });

            video.addEventListener('pause', function() {
                watchedTime += video.currentTime - lastTime;
                lastTime = video.currentTime;
            });

            video.addEventListener('ended', function() {
                watchedTime += video.currentTime - lastTime;
                const percentWatched = (watchedTime / video.duration) * 100;
                const stats = player.getStats();
                stats.percentWatched = percentWatched.toFixed(2);
                sendMetrics(stats);
                watchedTime = 0;
                lastTime = 0;
            });

            window.addEventListener('beforeunload', function() {
                watchedTime += video.currentTime - lastTime;
                const percentWatched = (watchedTime / video.duration) * 100;
                const stats = player.getStats();
                stats.percentWatched = percentWatched.toFixed(2);
                sendMetrics(stats);
            });
        });
    </script>
</body>
</html>
