<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Teste DASH - BigBuckBunny</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.7/shaka-player.compiled.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; text-align: center; }
        video { width: 80vw; max-width: 900px; margin: 2em auto; background: #000; }
    </style>
</head>
<body>
    <h1>Teste de Streaming MPEG-DASH</h1>
    <video id="videoPlayer" controls autoplay></video>
    <p>Se não aparecer vídeo, verifique o console do navegador para mensagens de erro.</p>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (shaka.Player.isBrowserSupported()) {
                var video = document.getElementById('videoPlayer');
                var player = new shaka.Player(video);
                var url = "http://localhost:8000/forbiggerfun/ForBiggerFun.mpd";
                player.load(url).then(function() {
                    console.log('O vídeo foi carregado com sucesso!');
                }).catch(function(error) {
                    console.error('Erro ao carregar o vídeo:', error);
                });

                // Métricas de taxa de abandono
                let watchedTime = 0;
                let lastTime = 0;

                video.addEventListener('play', function() {
                    lastTime = video.currentTime;
                });

                video.addEventListener('pause', function() {
                    watchedTime += video.currentTime - lastTime;
                    lastTime = video.currentTime;
                });

                // Exporta métricas automaticamente ao final do vídeo
                video.addEventListener('ended', function() {
                    watchedTime += video.currentTime - lastTime;
                    const percentWatched = (watchedTime / video.duration) * 100;
                    const stats = player.getStats();
                    // Adiciona percentWatched 
                    stats.percentWatched = percentWatched.toFixed(2);
                    const blob = new Blob([JSON.stringify(stats, null, 2)], { type: 'application/json' });
                    navigator.sendBeacon && navigator.sendBeacon('/shaka_metrics.json', blob);
                    console.log('Métricas enviadas automaticamente ao backend ao final do vídeo.');
                });

                // Exporta métricas ao abandonar a página (antes de fechar ou recarregar)
                window.addEventListener('beforeunload', function() {
                    watchedTime += video.currentTime - lastTime;
                    const percentWatched = (watchedTime / video.duration) * 100;
                    const stats = player.getStats();
                    // Adiciona percentWatched
                    stats.percentWatched = percentWatched.toFixed(2);
                    const blob = new Blob([JSON.stringify(stats, null, 2)], { type: 'application/json' });
                    navigator.sendBeacon && navigator.sendBeacon('/shaka_metrics.json', blob); 
                });
            } else {
                alert('Shaka Player não é suportado neste navegador.');
            }
        });
    </script>
</body>
</html>
